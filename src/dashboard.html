<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Eco Collect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <div id="loginRequired" class="alert alert-warning d-none">
    <h4>Login Required</h4>
    <p>Please <a href="login.html" class="alert-link">login</a> to access your dashboard.</p>
  </div>

  <div id="dashboardContent" class="d-none">
    <div class="row">
      <div class="col-md-8">
        <h2 class="text-success mb-4">My Dashboard</h2>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Welcome, <span id="userName"></span>!</h5>
          </div>
          <div class="card-body">
            <p>Email: <span id="userEmail"></span></p>
            <div class="mt-3">
              <a href="booking.html" class="btn btn-success me-2">Book New Service</a>
              <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5>My Bookings</h5>
          </div>
          <div class="card-body">
            <div id="loadingBookings" class="text-center">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div id="bookingsContainer"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="booking.html" class="btn btn-success">New Booking</a>
              <a href="contact.html" class="btn btn-outline-primary">Contact Support</a>
              <a href="index.html" class="btn btn-outline-secondary">Back to Home</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Check authentication and load dashboard
  document.addEventListener('DOMContentLoaded', async function() {
    const token = localStorage.getItem('userToken');
    const userData = localStorage.getItem('userData');
    
    if (!token || !userData) {
      document.getElementById('loginRequired').classList.remove('d-none');
      return;
    }

    try {
      const user = JSON.parse(userData);
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('dashboardContent').classList.remove('d-none');
      
      // Load user bookings
      await loadUserBookings();
    } catch (error) {
      console.error('Error loading dashboard:', error);
      document.getElementById('loginRequired').classList.remove('d-none');
    }
  });

  async function loadUserBookings() {
    const token = localStorage.getItem('userToken');
    
    try {
      const response = await fetch('/api/user/bookings', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const result = await response.json();
        displayBookings(result.bookings);
      } else if (response.status === 401) {
        // Token expired, redirect to login
        localStorage.removeItem('userToken');
        localStorage.removeItem('userData');
        window.location.href = 'login.html';
      } else {
        throw new Error('Failed to load bookings');
      }
    } catch (error) {
      console.error('Error loading bookings:', error);
      document.getElementById('bookingsContainer').innerHTML = 
        '<div class="alert alert-danger">Failed to load bookings. Please try again.</div>';
    } finally {
      document.getElementById('loadingBookings').style.display = 'none';
    }
  }

  function displayBookings(bookings) {
    const container = document.getElementById('bookingsContainer');
    
    if (bookings.length === 0) {
      container.innerHTML = '<p class="text-muted">No bookings found. <a href="booking.html">Create your first booking</a>!</p>';
      return;
    }

    const bookingsHtml = bookings.map(booking => {
      const statusClass = {
        'pending': 'warning',
        'completing': 'info',
        'completed': 'success'
      }[booking.status] || 'secondary';

      const createdDate = new Date(booking.created_at).toLocaleDateString();
      const bookingDate = new Date(booking.date).toLocaleDateString();

      return `
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h6 class="card-title">Booking #${booking.id}</h6>
                <p class="card-text">
                  <strong>Date:</strong> ${bookingDate} at ${booking.time}<br>
                  <strong>Address:</strong> ${booking.address}<br>
                  <strong>Created:</strong> ${createdDate}
                </p>
              </div>
              <div class="col-md-4 text-md-end">
                <span class="badge bg-${statusClass} fs-6">${booking.status.toUpperCase()}</span>
                ${booking.photo ? `<br><small><a href="/uploads/${booking.photo}" target="_blank" class="text-muted">View Photo</a></small>` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = bookingsHtml;
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      localStorage.removeItem('userToken');
      localStorage.removeItem('userData');
      window.location.href = 'index.html';
    }
  }
</script>
</body>
</html>