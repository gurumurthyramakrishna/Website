<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eco Collect - Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f6fff6; }
    .section-title { margin-top: 40px; margin-bottom: 20px; }
    img.waste-preview { max-width: 100px; max-height: 100px; object-fit: cover; }
    .status-completed { color: green; font-weight: bold; }
    .status-completing { color: blue; font-weight: bold; }
    .status-pending { color: red; font-weight: bold; }
  </style>
</head>
<body>
<div class="container mt-4">
  <h2 class="text-center mb-4">Eco Collect Admin Login</h2>
  <div id="loginForm">
    <input type="password" id="adminPassword" class="form-control mb-3" placeholder="Enter admin password">
    <button class="btn btn-success w-100" onclick="checkPassword()">Login</button>
    <div id="loginError" class="text-danger mt-2 text-center"></div>
  </div>

  <div id="adminPanel" style="display:none;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Eco Collect Admin</a>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-white" href="#pricing">Pricing</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="#orders">Orders</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="#messages">Messages</a></li>
          <li class="nav-item"><button class="btn btn-outline-light" onclick="logout()">Logout</button></li>
        </ul>
      </div>
    </nav>

    <!-- Pricing Section -->
    <section id="pricing">
      <h3 class="section-title text-success">Manage Pricing</h3>
      <form id="itemForm" class="row g-3">
        <div class="col-md-4">
          <input type="text" id="name" class="form-control" placeholder="Category Name" required />
        </div>
        <div class="col-md-4">
          <input type="text" id="desc" class="form-control" placeholder="Description" required />
        </div>
        <div class="col-md-2">
          <input type="number" id="price" class="form-control" placeholder="Price ₹" required />
        </div>

        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">Add Item</button>
        </div>
      </form>
      <div class="row mt-4" id="itemsList"></div>
    </section>

    <!-- Orders Section -->
    <section id="orders">
      <h3 class="section-title text-success">Scheduled Orders</h3>
      <table class="table table-bordered">
        <thead class="table-success">
        <tr>
          <th>Name</th>
          <th>Mobile</th>
          <th>Address</th>
          <th>Image</th>
          <th>Time</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody id="orderTableBody"></tbody>
      </table>
    </section>

    <!-- Messages Section -->
    <section id="messages">
      <h3 class="section-title text-success">Customer Messages</h3>
      <table class="table table-bordered">
        <thead class="table-success">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Message</th>
          <th>Time</th>
        </tr>
        </thead>
        <tbody id="messageTableBody"></tbody>
      </table>
    </section>
  </div>
</div>

<script>
  let adminToken = localStorage.getItem('adminToken');
  let items = [];

  async function checkPassword() {
    const password = document.getElementById("adminPassword").value;
    
    try {
      const response = await fetch('/api/admin/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password })
      });

      const result = await response.json();

      if (response.ok) {
        adminToken = result.token;
        localStorage.setItem('adminToken', adminToken);
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("loginError").innerText = "";
        
        // Load all data
        await loadPricingItems();
        await loadOrders();
        await loadMessages();
      } else {
        document.getElementById("loginError").innerText = result.error || "Login failed!";
      }
    } catch (error) {
      console.error('Login error:', error);
      document.getElementById("loginError").innerText = "Login failed. Please try again.";
    }
  }

  // Check if already logged in
  if (adminToken) {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadPricingItems();
    loadOrders();
    loadMessages();
  }

  // API Helper function
  async function apiCall(url, options = {}) {
    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${adminToken}`
      }
    };

    const mergedOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...options.headers
      }
    };

    const response = await fetch(url, mergedOptions);
    
    if (response.status === 401) {
      // Token expired, redirect to login
      localStorage.removeItem('adminToken');
      adminToken = null;
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("adminPanel").style.display = "none";
      throw new Error('Session expired');
    }

    return response;
  }

  // Pricing Management
  async function loadPricingItems() {
    try {
      const response = await fetch('/api/pricing');
      const result = await response.json();
      
      if (response.ok) {
        items = result.items;
        renderItems();
      } else {
        console.error('Failed to load pricing items:', result.error);
      }
    } catch (error) {
      console.error('Error loading pricing items:', error);
    }
  }

  function renderItems() {
    const container = document.getElementById("itemsList");
    container.innerHTML = "";
    
    items.forEach((item) => {
      const col = document.createElement("div");
      col.className = "col-md-4 mb-4";
      col.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">${item.name}</h5>
            <p class="card-text">${item.description}</p>
            <p class="card-text"><strong>₹${item.price}</strong></p>
            <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">Delete</button>
          </div>
        </div>`;
      container.appendChild(col);
    });
  }

  async function deleteItem(itemId) {
    try {
      const response = await apiCall(`/api/pricing/${itemId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        await loadPricingItems(); // Reload items
      } else {
        const result = await response.json();
        alert('Failed to delete item: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting item:', error);
      alert('Failed to delete item');
    }
  }

  document.getElementById("itemForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    
    const name = document.getElementById("name").value.trim();
    const description = document.getElementById("desc").value.trim();
    const price = parseFloat(document.getElementById("price").value.trim());

    if (name && description && price) {
      try {
        const response = await apiCall('/api/pricing', {
          method: 'POST',
          body: JSON.stringify({ name, description, price })
        });

        if (response.ok) {
          await loadPricingItems(); // Reload items
          this.reset();
        } else {
          const result = await response.json();
          alert('Failed to add item: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding item:', error);
        alert('Failed to add item');
      }
    }
  });

  // Orders Management
  async function loadOrders() {
    try {
      const response = await apiCall('/api/bookings');
      const result = await response.json();
      
      if (response.ok) {
        const orders = result.bookings;
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = "";

        orders.forEach((order) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.name}</td>
            <td>${order.email}</td>
            <td>${order.address}</td>
            <td><img src="/uploads/${order.photo}" class="waste-preview" alt="Waste photo" /></td>
            <td>${order.date} ${order.time}</td>
            <td>
              <select class="form-select status-dropdown ${getStatusClass(order.status)}"
                      onchange="updateOrderStatus(${order.id}, this.value)">
                <option value="completed" ${order.status === "completed" ? "selected" : ""}>Completed</option>
                <option value="completing" ${order.status === "completing" ? "selected" : ""}>Completing</option>
                <option value="pending" ${order.status === "pending" ? "selected" : ""}>Pending</option>
              </select>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        console.error('Failed to load orders:', result.error);
      }
    } catch (error) {
      console.error('Error loading orders:', error);
    }
  }

  async function updateOrderStatus(orderId, newStatus) {
    try {
      const response = await apiCall(`/api/bookings/${orderId}/status`, {
        method: 'PUT',
        body: JSON.stringify({ status: newStatus })
      });

      if (response.ok) {
        await loadOrders(); // Reload orders
      } else {
        const result = await response.json();
        alert('Failed to update status: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error updating order status:', error);
      alert('Failed to update status');
    }
  }

  function getStatusClass(status) {
    if (status === "completed") return "status-completed";
    if (status === "completing") return "status-completing";
    return "status-pending";
  }

  // Messages Management
  async function loadMessages() {
    try {
      const response = await apiCall('/api/contact');
      const result = await response.json();
      
      if (response.ok) {
        const messages = result.messages;
        const tableBody = document.getElementById("messageTableBody");
        tableBody.innerHTML = "";

        messages.forEach(msg => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${msg.name}</td>
            <td>${msg.email}</td>
            <td>${msg.message}</td>
            <td>${new Date(msg.created_at).toLocaleString()}</td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        console.error('Failed to load messages:', result.error);
      }
    } catch (error) {
      console.error('Error loading messages:', error);
    }
  }

  // Logout function
  function logout() {
    localStorage.removeItem('adminToken');
    adminToken = null;
    document.getElementById("loginForm").style.display = "block";
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("adminPassword").value = "";
  }
</script>
</body>
</html>
